## Домашнее задание к занятию "6.6. Troubleshooting"

### Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя

---

**Решение:**

```bash
1. Необходимо найти opid операции:

db.currentOp({ "active" : true, "secs_running" : { "$gt" : 180 }})

{
    "inprog" : [
        {
            //...
            "opid" : 12345,
            "secs_running" : NumberLong(123)
            //...
        }
    ]
}

2. Завершить принудительно

db.killOp(12345)
```
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB

**Ответ:**

```bash
1. Использовать метод maxTimeMS() для ограничения времени выполнения операций; 
2. Используя Database Profiler, отловить медленные операции;
3. Провести анализ плана выполнения запроса через explain("executionStats");
4. Провести оптимизацию: добавить/скорректировать/удалить индексы, настроить шардинг.
```

---

### Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи

Как вы думаете, в чем может быть проблема?

---

**Ответ:**

```bash
Блокировка операций записи вероятно происходит из-за того что Redis достиг выделенного объема оперативной памяти под кэширование, которое указано в параметре maxmemory. 
При достижении данного параметра Redis начинает удалять ключи согласно политике опреденной в параметре maxmemory-policy. 
Стоит проанализировать данные на комличество записей сс истекшим TTL. 
Имеет смысл сменить политику очиски кэша.
```

---
 
### Задача 3

Перед выполнением задания познакомьтесь с документацией по [Common Mysql errors](https://dev.mysql.com/doc/refman/8.0/en/common-errors.html).

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

---

Как вы думаете, почему это начало происходить и как локализовать проблему?

**Ответ:**

```bash
Основываясь на документации MySQL https://dev.mysql.com/doc/refman/8.0/en/error-lost-connection.html возможны три причины:
1. Слишком объемные запросы на миллионы строк, рекомендуется увеличение параметра net_read_timeout;
2. Малое значение параметра connect_timeout, клиент не успевает установить соединение;
3. Размер сообщения/запроса превышает размер буфера max_allowed_packet на сервере или max_allowed_packet на строне клиента.
```

Какие пути решения данной проблемы вы можете предложить?

**Ответ:**

```bash
В документации указано, что форма "during query" возникает при очень больших запросах. 
Следует увеличить время net_read_timeou так, чтобы его было достаточно для завершения передачи данных. 
Реже, клиент не успевает установить соединение с сервером. Для устаранения требуется увеличить значение connect_timeout. 
```

---

### Задача 4

Перед выполнением задания ознакомьтесь со статьей [Common PostgreSQL errors](https://www.percona.com/blog/2020/06/05/10-common-postgresql-errors/) из блога Percona.

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

---

Как вы думаете, что происходит?

**Ответ:**

```bash
Данная ошибка возникает при нехватки выделяемой процессам памяти на сервере, в этом случае происходит принудительная остановка какого-либо процесса, который определяется OOM-Killer. 
Можно отключить OOM-Killer, но это не рекомендуется. 
В качестве решения проблемы можно выставить параметр машины vm.overcommit_memory в значение 2. 
В этом случае происходит отказ в обработке запросов, которые запрашивают память большую чем размер памяти пространства подкачки и ОЗУ в соответствии с параметром overcommit_ratio.
```
Как бы вы решили данную проблему?

**Ответ:**

```bash
1. По возможности добавить ресурсов (RAM), провести ревизию и отключить/перенести ненужные приложения.
2. Произвести настройку параметров, затрагивающих память в Postgres:
max_connections
shared_buffer
work_mem
effective_cache_size
maintenance_work_mem
```

---